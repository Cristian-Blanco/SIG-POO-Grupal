<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Catastro 3D - Barrio María Cano</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <link rel="stylesheet" href="src/css/20252094014.css" />
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; }
  </style>
</head>
<body>
    <!-- ==================== FILA 1: Encabezado con logo + título ==================== -->
    <header class="topbar">
      <!-- Contenedor que alinea logo y título en una sola fila y los centra -->
      <div class="logo-title">
        <!-- Logo del barrio: atributo alt para accesibilidad y loading lazy para optimizar -->
        <img
          src="https://uploads.knightlab.com/storymapjs/7f1f7a40dec75712842017c6dcdce290/ruta-de-maria-cano/_images/mariacano.png"
          alt="Logo Barrio María Cano"
          class="logo"
          loading="lazy"
        />
        <!-- Título principal del sitio -->
        <h1 class="title">Barrio María Cano – Bogotá D.C. – Colombia - Catastro 3D</h1>
      </div>
    </header>
  
    <!-- ==================== FILA 2: Navegación principal ==================== -->
    <!-- role="navigation" y aria-label mejoran accesibilidad para lectores de pantalla -->
    <nav class="navgrid" role="navigation" aria-label="Navegación principal">
      <!-- ========== Menú desplegable: Equipamiento ========== -->
      <!-- .dropdown posiciona el submenú y .dropbtn es el botón que abre/cierra -->
      <div class="navitem dropdown">
        <!-- aria-haspopup/expanded informan del estado del menú al lector de pantalla -->
        <button class="dropbtn" aria-haspopup="true" aria-expanded="false">
          Equipamiento <span class="caret" aria-hidden="true">▾</span>
        </button>
        <!-- Submenú con enlaces a páginas de cada equipamiento -->
        <ul class="dropdown-menu" role="menu" aria-label="Submenú de Equipamiento">
          <!-- Cada <a> apunta a una página distinta (a crear por separado) -->
          <li role="none"><a role="menuitem" href="ubicacion.html">Ubicación</a></li>
          <li role="none"><a role="menuitem" href="movilidad.html">Movilidad</a></li>
          <li role="none"><a role="menuitem" href="troncales.html">Troncales</a></li>
          <li role="none"><a role="menuitem" href="parques.html">Parques</a></li>
          <li role="none"><a role="menuitem" href="vias.html">Vías</a></li>
          <li role="none"><a role="menuitem" href="catastro3d.html">Catastros 3D</a></li>
          <li role="none"><a role="menuitem" href="recorrido-virtual.html">Recorrido Virtual</a></li>
        </ul>
      </div>
  
      <!-- Otros enlaces de navegación simples.. -->
      <a class="navitem" href="problemas.html" title="Ir a Problemas">Problemas</a>
      <!-- Enlace con logo a la derecha para "Acerca de" -->
      <a class="navitem acerca" href="acerca.html" title="Ir a Acerca de">
        Acerca de
        <img
          src="https://previews.123rf.com/images/valentint/valentint1704/valentint170400665/75401422-about-us-icon-about-us-website-button-on-white-background.jpg"
          alt="Logo Acerca de"
          class="acerca-logo"
          loading="lazy"
        />
      </a>
    </nav>
<div id="cesiumContainer"></div>
<script src="src/js/programa.js" defer></script>
<script type="module">
   Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3ZjBjZWNjNi1lN2E2LTQxN2EtOWY2MS0xZjliMjIxMDZmMzUiLCJpZCI6MzMxMzU3LCJpYXQiOjE3NTUwNDI1NTB9.CLqrLXgbk4VfneVH0NK8xmkyEll98A0whFdesGkvMTo';

  const viewer = new Cesium.Viewer("cesiumContainer", {
    terrain: Cesium.Terrain.fromWorldTerrain(),
    baseLayer: Cesium.ImageryLayer.fromProviderAsync(
      Cesium.ArcGisMapServerImageryProvider.fromBasemapType(
        Cesium.ArcGisBaseMapType.SATELLITE
      )
    ),
    timeline:false, animation:false, shadows:true
  });
  viewer.scene.globe.depthTestAgainstTerrain = true;

  // 1) Carga construcciones (EPSG:4326)
  const ds = await Cesium.GeoJsonDataSource.load("src/assets/20252094014.geojson");
  await viewer.dataSources.add(ds);

  // 2) Función para centrar la cámara
  await viewer.zoomTo(ds);

  // 3) Anclar cada polígono al terreno y extruir por CONNPISOS*3
  const entities = ds.entities.values;

  // Pequeño helper para aproximar el centro del polígono
  function centroidCartographic(entity) {
    const pos = entity.polygon.hierarchy.getValue().positions;
    const bs = Cesium.BoundingSphere.fromPoints(pos);
    return Cesium.Ellipsoid.WGS84.cartesianToCartographic(bs.center);
  }

  // Construimos una lista de muestras al terreno
  const samples = [];
  for (const e of entities) {
    if (!e.polygon) continue;
    const carto = centroidCartographic(e);
    samples.push(carto);
  }
  // Muestrear terreno a máxima resolución disponible
  await Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, samples);

  // Aplicar alturas absolutas (base en terreno + extrusión por pisos)
  for (let i = 0; i < entities.length; i++) {
    const e = entities[i];
    const pol = e.polygon;
    if (!pol) continue;

    const pisos = Number(e.properties?.CONNPISOS?.getValue?.());
    const altura = Number.isFinite(pisos) ? pisos * 3 : 6; // 3 m/piso

    const base = samples[i].height; // metros sobre el elipsoide
    pol.material = Cesium.Color.fromCssColorString("#7a8a50").withAlpha(0.95);
    pol.outline = true;
    pol.outlineColor = Cesium.Color.BLACK;

    // Alturas ABSOLUTAS: sin heightReference (evita “flotantes”)
    pol.height = base;
    pol.extrudedHeight = base + altura;
    pol.perPositionHeight = false;
  }
  
  viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(-74.17648138133184, 4.589581121293994, 2700),
      orientation: { heading: 0, pitch: Cesium.Math.toRadians(-25) }
    });

  viewer.homeButton.viewModel.command.beforeExecute.addEventListener(function(e) {
    e.cancel = true;
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(-74.17648138133184, 4.589581121293994, 2700),
      orientation: {
        heading: 0,
        pitch: Cesium.Math.toRadians(-25)
      }
    });
  });
</script>
</body>
</html>